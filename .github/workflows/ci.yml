name: CI

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  desktop-checks:
    name: Desktop Lint, Typecheck, Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Desktop lint
        run: pnpm run lint

      - name: Typecheck
        run: pnpm exec tsc -b

      - name: Desktop build
        run: pnpm build

      - name: Audit dependencies (high+)
        run: |
          output=$(pnpm audit --audit-level=high 2>&1) && exit 0
          if echo "$output" | grep -q "ERR_PNPM_AUDIT_BAD_RESPONSE"; then
            echo "::warning::npm audit endpoint unavailable, skipping"
            exit 0
          fi
          echo "$output"
          exit 1

  frontend-checks:
    name: Frontend Lint, Typecheck, Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Frontend lint
        run: pnpm -C web run lint

      - name: Frontend typecheck
        run: pnpm -C web exec tsc --noEmit

      - name: Frontend build
        run: pnpm -C web run build

  smoke-scope:
    name: Smoke Scope
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decide.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Decide smoke scope
        id: decide
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || '' }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || '' }}
        run: |
          if [ "$EVENT_NAME" = "push" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          changed_files="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"
          echo "Changed files:"
          echo "$changed_files"

          if echo "$changed_files" | grep -Eq '^(src/|tests/|playwright\.smoke\.config\.ts|electron\.vite\.config\.ts|package\.json|pnpm-lock\.yaml|\.github/workflows/ci\.yml)'; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  smoke-desktop:
    name: Desktop Smoke (Electron)
    if: needs.smoke-scope.outputs.should_run == 'true'
    needs:
      - desktop-checks
      - frontend-checks
      - smoke-scope
    runs-on: macos-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run smoke tests
        run: pnpm test:smoke

      - name: Upload smoke artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-artifacts
          path: |
            playwright-report
            test-results
          if-no-files-found: ignore
